name: Run Reputation Oracle

permissions:
  contents: read

on:
  workflow_dispatch:
  schedule:
    - cron: '30 1 * * *' # every day at 01:30

jobs:
  run-rep-o:
    name: Run Reputation Oracle
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./reputation-oracle
    strategy:
      matrix:
        env: [staging, production]
    environment: ${{ matrix.env }}
    steps:
      - uses: actions/checkout@v4
      - name: Enable corepack
        run: corepack enable
      - uses: actions/setup-node@v4
        with:
          node-version-file: .nvmrc
          cache: yarn
          cache-dependency-path: 'yarn.lock'
      - name: Install dependencies
        run: yarn install
      - name: Write .env
        run: |
          cat <<EOF > .env.${{ matrix.environment }}
          ${{ secrets.MY_PRIVATE_KEY }}
          EOF
      - name: Run
        run: yarn start
        env:
          LOGGER_PRETTY: true
          NODE_ENV: ${{ matrix.environment }}
          S3_ENDPOINT: ${{ secrets.REPUTATION_ORACLE_S3_ENDPOINT }}
          S3_PORT: ${{ secrets.REPUTATION_ORACLE_S3_PORT }}
          S3_ACCESS_KEY: ${{ secrets.REPUTATION_ORACLE_S3_ACCESS_KEY }}
          S3_SECRET_KEY: ${{ secrets.REPUTATION_ORACLE_S3_SECRET_KEY }}
          S3_BUCKET: ${{ secrets.REPUTATION_ORACLE_S3_BUCKET }}
          S3_USE_SSL: true
          WEB3_PRIVATE_KEY: ${{ secrets.REPUTATION_ORACLE_WEB3_PRIVATE_KEY }}
          RPC_URL_POLYGON_AMOY: ${{ secrets.REPUTATION_ORACLE_POLYGON_AMOY }}
          RPC_URL_POLYGON: ${{ secrets.REPUTATION_ORACLE_RPC_URL_POLYGON }}
          SUBGRAPH_API_KEY: ${{ secrets.REPUTATION_ORACLE_SUBGRAPH_API_KEY }}
