name: Service CI

permissions:
  contents: read

on:
  push:
    branches:
      - main
  pull_request:

jobs:
  changes:
    name: Detect affected services
    runs-on: ubuntu-latest
    outputs:
      common: ${{ steps.filter.outputs.common }}
      campaign_launcher_client: ${{ steps.filter.outputs.campaign_launcher_client }}
      campaign_launcher_server: ${{ steps.filter.outputs.campaign_launcher_server }}
      recording_oracle: ${{ steps.filter.outputs.recording_oracle }}
      reputation_oracle: ${{ steps.filter.outputs.reputation_oracle }}
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - id: filter
        name: Evaluate path filters
        uses: dorny/paths-filter@v3
        with:
          filters: |
            common:
              - .nvmrc
              - package.json
              - .github/workflows/ci-services.yaml
              - .github/workflows/ci-lint-service.yaml
              - .github/workflows/ci-test-service.yaml
            campaign_launcher_client:
              - campaign-launcher/client/**
            campaign_launcher_server:
              - campaign-launcher/server/**
            recording_oracle:
              - recording-oracle/**
            reputation_oracle:
              - reputation-oracle/**

  lint:
    name: Lint (${{ matrix.name }})
    needs: changes
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: Campaign Launcher Client
            working-directory: campaign-launcher/client
            filter: campaign_launcher_client
          - name: Campaign Launcher Server
            working-directory: campaign-launcher/server
            filter: campaign_launcher_server
          - name: Recording Oracle
            working-directory: recording-oracle
            filter: recording_oracle
          - name: Reputation Oracle
            working-directory: reputation-oracle
            filter: reputation_oracle
    uses: ./.github/workflows/ci-lint-service.yaml
    with:
      working-directory: ${{ matrix.working-directory }}
      enabled: ${{ needs.changes.outputs.common == 'true' || needs.changes.outputs[matrix.filter] == 'true' }}

  test:
    name: Tests (${{ matrix.name }})
    needs: changes
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: Campaign Launcher Server
            working-directory: campaign-launcher/server
            filter: campaign_launcher_server
          - name: Recording Oracle
            working-directory: recording-oracle
            filter: recording_oracle
          - name: Reputation Oracle
            working-directory: reputation-oracle
            filter: reputation_oracle
    uses: ./.github/workflows/ci-test-service.yaml
    with:
      working-directory: ${{ matrix.working-directory }}
      enabled: ${{ needs.changes.outputs.common == 'true' || needs.changes.outputs[matrix.filter] == 'true' }}
