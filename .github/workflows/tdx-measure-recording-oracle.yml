name: TDX Measure Recording Oracle

on:
  push:
    branches: [main]
    paths:
      - 'recording-oracle/**'
      - '.github/workflows/tdx-measure-recording-oracle.yml'
  pull_request:
    branches: [main]
    paths:
      - 'recording-oracle/**'
      - '.github/workflows/tdx-measure-recording-oracle.yml'
  workflow_dispatch:
    inputs:
      publish_release:
        description: 'Publish measurements to release'
        required: false
        default: 'false'
        type: boolean

env:
  TDX_HOST: ns3222044.ip-57-130-10.eu
  TDX_HOST_USER: ubuntu
  RECORDING_ORACLE_PORT: 12000
  VM_NAME: recording-oracle-tdx
  VM_SSH_PORT: 2222
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}/recording-oracle

jobs:
  build-image:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
      id-token: write
      attestations: write
    outputs:
      image_sha: ${{ steps.image-tag.outputs.image_sha }}
      image_digest: ${{ steps.build.outputs.digest }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Compute image tag
        id: image-tag
        run: |
          IMAGE_SHA="ghcr.io/${{ github.repository }}/recording-oracle:sha-${{ github.sha }}"
          echo "image_sha=$IMAGE_SHA" >> $GITHUB_OUTPUT
          echo "Image will be tagged as: $IMAGE_SHA"

      - name: Determine Docker tags
        id: docker-tags
        run: |
          TAGS="ghcr.io/${{ github.repository }}/recording-oracle:sha-${{ github.sha }}"
          if [ "${{ github.event_name }}" = "push" ]; then
            TAGS="$TAGS,ghcr.io/${{ github.repository }}/recording-oracle:latest"
          fi
          echo "tags=$TAGS" >> $GITHUB_OUTPUT

      - name: Build and push Docker image
        id: build
        uses: docker/build-push-action@v5
        with:
          context: ./recording-oracle
          file: ./recording-oracle/Dockerfile
          push: true
          tags: ${{ steps.docker-tags.outputs.tags }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Attest Docker image provenance
        uses: actions/attest-build-provenance@v2
        with:
          subject-name: ghcr.io/${{ github.repository }}/recording-oracle
          subject-digest: ${{ steps.build.outputs.digest }}
          push-to-registry: true

  measure-tdx:
    runs-on: ubuntu-latest
    needs: build-image
    permissions:
      contents: write
      id-token: write
      attestations: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Ansible and dependencies
        run: |
          pip install ansible
          sudo apt-get update && sudo apt-get install -y sshpass

      - name: Setup SSH agent with key
        run: |
          # Start SSH agent and add key
          eval "$(ssh-agent -s)"
          echo "${{ secrets.TDX_HOST_SSH_KEY }}" | ssh-add -
          
          # Export agent socket for subsequent steps
          echo "SSH_AUTH_SOCK=$SSH_AUTH_SOCK" >> $GITHUB_ENV
          echo "SSH_AGENT_PID=$SSH_AGENT_PID" >> $GITHUB_ENV
          
          # Add host to known_hosts
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ env.TDX_HOST }} >> ~/.ssh/known_hosts 2>/dev/null || true

      - name: Check TDX host connectivity
        run: |
          echo "Testing SSH connection to TDX host..."
          ssh -T -o StrictHostKeyChecking=no -o ConnectTimeout=10 ${{ env.TDX_HOST_USER }}@${{ env.TDX_HOST }} "echo 'TDX host connection successful'" || {
            echo "::error::Cannot connect to TDX host. Please ensure the host is accessible."
            exit 1
          }

      - name: Create Ansible inventory
        run: |
          cat > /tmp/inventory.yml << EOF
          all:
            hosts:
              tdx_host:
                ansible_host: ${{ env.TDX_HOST }}
                ansible_user: ${{ env.TDX_HOST_USER }}
                ansible_python_interpreter: /usr/bin/python3
          EOF
          cat /tmp/inventory.yml

      - name: Build TDX guest image (if needed)
        working-directory: ./recording-oracle/ansible
        env:
          ANSIBLE_HOST_KEY_CHECKING: "False"
        run: |
          echo "Ensuring TDX guest image is built with canonical/tdx setup..."
          ansible-playbook -i /tmp/inventory.yml playbooks/build-tdx-image.yml -v
          echo "TDX guest image ready"

      - name: Deploy TDX VM with Ansible
        working-directory: ./recording-oracle/ansible
        env:
          ANSIBLE_HOST_KEY_CHECKING: "False"
        run: |
          echo "Deploying fresh TDX VM with Ansible..."
          echo "Using image: ${{ needs.build-image.outputs.image_sha }}"
          ansible-playbook -i /tmp/inventory.yml playbooks/deploy.yml \
            -e "recording_oracle_image=${{ needs.build-image.outputs.image_sha }}" \
            -e "vm_name=${{ env.VM_NAME }}" \
            -e "vm_ssh_port=${{ env.VM_SSH_PORT }}" \
            -e "recording_oracle_port=${{ env.RECORDING_ORACLE_PORT }}" \
            -e "vm_ready_timeout=300" \
            -v

      - name: Get TDX measurements with Ansible
        id: get-measurements
        working-directory: ./recording-oracle/ansible
        env:
          ANSIBLE_HOST_KEY_CHECKING: "False"
        run: |
          ansible-playbook -i /tmp/inventory.yml playbooks/measure.yml \
            -e "recording_oracle_port=${{ env.RECORDING_ORACLE_PORT }}" \
            -e "measurements_output_file=${{ github.workspace }}/measurements.json" \
            -v
          
          # Parse measurements for GitHub outputs
          if [ -f "${{ github.workspace }}/measurements.json" ]; then
            echo "=== TDX Measurements ==="
            cat "${{ github.workspace }}/measurements.json"
            
            MRTD=$(jq -r '.mrtd // empty' "${{ github.workspace }}/measurements.json")
            RTMR0=$(jq -r '.rtmr0 // empty' "${{ github.workspace }}/measurements.json")
            RTMR1=$(jq -r '.rtmr1 // empty' "${{ github.workspace }}/measurements.json")
            RTMR2=$(jq -r '.rtmr2 // empty' "${{ github.workspace }}/measurements.json")
            RTMR3=$(jq -r '.rtmr3 // empty' "${{ github.workspace }}/measurements.json")
            
            echo "mrtd=$MRTD" >> $GITHUB_OUTPUT
            echo "rtmr0=$RTMR0" >> $GITHUB_OUTPUT
            echo "rtmr1=$RTMR1" >> $GITHUB_OUTPUT
            echo "rtmr2=$RTMR2" >> $GITHUB_OUTPUT
            echo "rtmr3=$RTMR3" >> $GITHUB_OUTPUT
          fi

      - name: Check TDX status with Ansible
        working-directory: ./recording-oracle/ansible
        env:
          ANSIBLE_HOST_KEY_CHECKING: "False"
        run: |
          ansible-playbook -i /tmp/inventory.yml playbooks/status.yml \
            -e "vm_name=${{ env.VM_NAME }}" \
            -e "recording_oracle_port=${{ env.RECORDING_ORACLE_PORT }}" \
            -v

      - name: Enrich measurements manifest
        run: |
          # Add build metadata to measurements
          if [ -f measurements.json ]; then
            jq --arg sha "${{ github.sha }}" \
               --arg ref "${{ github.ref }}" \
               --arg run_id "${{ github.run_id }}" \
               --arg run_number "${{ github.run_number }}" \
               --arg image "${{ needs.build-image.outputs.image_sha }}" \
               '. + {
                 git_sha: $sha,
                 git_ref: $ref,
                 workflow_run_id: $run_id,
                 workflow_run_number: $run_number,
                 docker_image: $image
               }' measurements.json > measurements_enriched.json
            mv measurements_enriched.json measurements.json
            echo "=== Enriched Measurements ==="
            cat measurements.json
          fi

      - name: Create reproduction instructions
        run: |
          cat > REPRODUCE.md << 'EOF'
          # Reproducing TDX Measurements
          
          ## Prerequisites
          - Access to TDX-enabled hardware
          - Docker installed
          - Ansible installed
          
          ## Steps
          
          1. Pull the exact Docker image:
          ```bash
          docker pull ${{ needs.build-image.outputs.image_sha }}
          ```
          
          2. Build TDX guest image (first time only):
          ```bash
          cd recording-oracle/ansible
          ansible-playbook -i your-inventory.yml playbooks/build-tdx-image.yml
          ```

          3. Deploy on TDX hardware using Ansible:
          ```bash
          ansible-playbook -i your-inventory.yml playbooks/deploy.yml \
            -e "recording_oracle_image=${{ needs.build-image.outputs.image_sha }}"
          ```

          4. Get measurements:
          ```bash
          ansible-playbook -i your-inventory.yml playbooks/measure.yml
          ```
          
          ## Expected Measurements
          
          | Register | Value |
          |----------|-------|
          | MRTD | `${{ steps.get-measurements.outputs.mrtd }}` |
          | RTMR[0] | `${{ steps.get-measurements.outputs.rtmr0 }}` |
          | RTMR[1] | `${{ steps.get-measurements.outputs.rtmr1 }}` |
          | RTMR[2] | `${{ steps.get-measurements.outputs.rtmr2 }}` |
          | RTMR[3] | `${{ steps.get-measurements.outputs.rtmr3 }}` |
          
          ## Build Info
          - Git SHA: `${{ github.sha }}`
          - Docker Image: `${{ needs.build-image.outputs.image_sha }}`
          - Workflow Run: `${{ github.run_id }}`
          EOF

      - name: Attest measurements provenance
        uses: actions/attest-build-provenance@v2
        with:
          subject-path: measurements.json

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: tdx-measurements
          path: |
            measurements.json
            REPRODUCE.md
          retention-days: 90

      - name: Create release with measurements
        if: github.event_name == 'push' && github.ref == 'refs/heads/main' || github.event.inputs.publish_release == 'true'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: recording-oracle-${{ github.sha }}
          name: Recording Oracle TDX Build - ${{ github.sha }}
          body: |
            ## TDX Recording Oracle Measurements

            Measurements from recording oracle running on **real TDX hardware**.

            ### Build Info
            | Field | Value |
            |-------|-------|
            | Git SHA | `${{ github.sha }}` |
            | Docker Image | `${{ needs.build-image.outputs.image_sha }}` |

            ### TDX Measurements
            | Register | Value |
            |----------|-------|
            | MRTD | `${{ steps.get-measurements.outputs.mrtd }}` |
            | RTMR[0] | `${{ steps.get-measurements.outputs.rtmr0 }}` |
            | RTMR[1] | `${{ steps.get-measurements.outputs.rtmr1 }}` |
            | RTMR[2] | `${{ steps.get-measurements.outputs.rtmr2 }}` |
            | RTMR[3] | `${{ steps.get-measurements.outputs.rtmr3 }}` |

            ### Attestation Verification

            Both the Docker image and measurements.json are signed with GitHub Artifact Attestations.

            Verify the Docker image:
            ```bash
            gh attestation verify oci://ghcr.io/${{ github.repository }}/recording-oracle:sha-${{ github.sha }} --owner ${{ github.repository_owner }}
            ```

            Verify measurements.json:
            ```bash
            gh attestation verify measurements.json --owner ${{ github.repository_owner }}
            ```

            ### Running This Exact Build

            ```bash
            docker pull ${{ needs.build-image.outputs.image_sha }}
            docker run -p 12000:12000 ${{ needs.build-image.outputs.image_sha }}
            ```
          files: |
            measurements.json
            REPRODUCE.md
          draft: false
          prerelease: false
