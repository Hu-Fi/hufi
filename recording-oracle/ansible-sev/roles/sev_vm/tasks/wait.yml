---
# Wait for SEV VM to be ready

- name: Wait for VM to be in running state
  ansible.builtin.command:
    cmd: virsh domstate {{ vm_name }}
  register: vm_state
  until: vm_state.stdout | trim == 'running'
  retries: 30
  delay: 5
  changed_when: false

- name: Wait for VM to boot (initial delay)
  ansible.builtin.pause:
    seconds: 60
  when: true

- name: Wait for SSH port to be available
  ansible.builtin.wait_for:
    host: 127.0.0.1
    port: "{{ vm_ssh_port }}"
    timeout: "{{ vm_ready_timeout }}"
    state: started
  register: ssh_wait

- name: Wait additional time for cloud-init to complete
  ansible.builtin.pause:
    seconds: 60
  when: ssh_wait is changed or ssh_wait.elapsed | default(0) < 10

- name: Test SSH connection
  block:
    - name: Attempt SSH connection
      ansible.builtin.command:
        cmd: >
          sshpass -p '{{ guest_password }}' ssh
          -o StrictHostKeyChecking=no
          -o UserKnownHostsFile=/dev/null
          -o ConnectTimeout={{ ssh_connect_timeout }}
          -p {{ vm_ssh_port }}
          {{ guest_user }}@127.0.0.1
          'echo SSH_OK'
      register: ssh_test
      until: ssh_test.rc == 0 and 'SSH_OK' in ssh_test.stdout
      retries: 60
      delay: 5
      changed_when: false

    - name: Display SSH connection status
      ansible.builtin.debug:
        msg: "SSH connection established to {{ vm_name }}"

  rescue:
    - name: Check VM state
      ansible.builtin.command:
        cmd: virsh domstate {{ vm_name }}
      register: vm_state
      failed_when: false
      changed_when: false

    - name: Show VM state
      ansible.builtin.debug:
        msg: "VM state: {{ vm_state.stdout | default('unknown') }}"

    - name: Check VM console log file
      ansible.builtin.shell:
        cmd: |
          echo "=== Checking for console log files ==="
          ls -la /var/log/libvirt/qemu/{{ vm_name }}* 2>/dev/null || echo "No log files found"
          echo "=== Last 100 lines of serial log ==="
          tail -100 /var/log/libvirt/qemu/{{ vm_name }}-serial.log 2>/dev/null || echo "No serial log content"
      register: console_log_file
      failed_when: false
      changed_when: false

    - name: Show console log file
      ansible.builtin.debug:
        var: console_log_file.stdout_lines
      when: console_log_file.stdout_lines is defined

    - name: Check dmesg for SEV/VM related messages
      ansible.builtin.shell:
        cmd: |
          echo "=== Host dmesg for SEV/KVM ==="
          dmesg | grep -iE 'sev|kvm|qemu|amd' | tail -30 || echo "No SEV/KVM messages"
      register: host_dmesg
      failed_when: false
      changed_when: false

    - name: Show host dmesg
      ansible.builtin.debug:
        var: host_dmesg.stdout_lines
      when: host_dmesg.stdout_lines is defined

    - name: Fail with helpful message
      ansible.builtin.fail:
        msg: |
          SSH connection to VM failed after 60 retries.
          Last SSH error: {{ ssh_test.stderr | default('No error message') }}

          Possible causes:
          1. Cloud-init may not have completed - check console output above
          2. SSH service may not be running inside the VM
          3. Network configuration issue with QEMU user-mode networking
          4. SEV may not be properly configured on the host

- name: Check if recording oracle is running
  ansible.builtin.uri:
    url: "http://127.0.0.1:{{ recording_oracle_port }}/"
    method: GET
    timeout: 10
    follow_redirects: none
    status_code: [200, 301, 302, 308]
  register: oracle_check
  until: oracle_check.status in [200, 301, 302, 308]
  retries: 60
  delay: 5
  failed_when: false

- name: Display oracle status
  ansible.builtin.debug:
    msg: "Recording oracle: {{ 'Running' if oracle_check.status | default(0) in [200, 301, 302, 308] else 'Not ready yet' }}"

- name: Check SEV attestation proxy status
  ansible.builtin.uri:
    url: "http://127.0.0.1:{{ sev_proxy_host_port | default(8082) }}/status"
    method: GET
    timeout: 10
  register: sev_status
  failed_when: false

- name: Display SEV status
  ansible.builtin.debug:
    msg: "SEV Proxy: {{ sev_status.json | default({'available': 'unknown'}) }}"
  when: sev_status.status | default(0) == 200
